---
title: ADR-0002 監査ログ方式
description: イベントログ方式 + 重要テーブルのみDBトリガ併用を採用
---

## ステータス
**Accepted**（2026-02-23）

## コンテキスト
OpsHub では NFR-05（監査要件）を満たすため、「誰が・いつ・何をしたか」を記録する仕組みが必要。
選択肢として以下を検討した：

1. **全テーブルにDBトリガ** — 変更履歴を自動記録
2. **アプリ層のイベントログのみ** — Server Action 内で明示的に記録
3. **併用** — アプリ層イベントログを中心に、重要テーブルのみDBトリガで補完

## 決定
**方式3: イベントログ中心 + 重要テーブルのみDBトリガ併用**

## 理由

### イベントログ（中心）を選んだ理由
- **操作のコンテキスト（who/why）を記録できる**: DBトリガではアプリ層の情報（操作者の意図、UIアクション名）を取得しにくい
- **制御しやすい**: 記録対象を明示的に選択でき、不要なログ（参照系等）を排除できる
- **テスト容易性**: Server Action のユニットテストで監査ログ記録を検証可能

### 全テーブルトリガを採用しなかった理由
- **データ量が膨大**: 全CRUDを自動記録するとストレージ消費が急増
- **パフォーマンス影響**: 全テーブルのINSERT/UPDATEにトリガが追加される
- **ノイズが多い**: 参照系や一時データの変更まで記録され、有用な監査情報が埋もれる

### 重要テーブルにDBトリガを併用する理由
- **改ざん耐性**: アプリ層のログはコードの漏れで記録されない可能性がある
- **金銭・権限に関わるデータ**: 法的にも変更履歴が必要な領域
- **二重記録による安全性**: アプリ層で漏れてもDB層で捕捉できる

## トリガ対象テーブル

| テーブル | トリガ | 理由 |
|---|---|---|
| `user_roles` | ✅ | 権限変更 — セキュリティ上必須 |
| `workflows`（status変更時のみ） | ✅ | 承認・差戻しの法的証跡 |
| `invoices` / `payments` | ✅ | 金額データの改ざん防止 |
| その他（projects, tasks, timesheets等） | ❌ | Server Action のイベントログで十分 |

## 実装方針

### イベントログ（Server Action 内）
```typescript
// Server Action 内で業務操作の直後に記録
await supabase.from("audit_logs").insert({
  action: "workflow.approve",
  resource_type: "workflow",
  resource_id: workflowId,
  before: { status: "submitted" },
  after: { status: "approved" },
});
```

### DBトリガ（重要テーブル）
```sql
CREATE OR REPLACE FUNCTION audit_trigger()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO audit_logs (
    tenant_id, user_id, action, resource_type, resource_id, before, after
  ) VALUES (
    COALESCE(NEW.tenant_id, OLD.tenant_id),
    auth.uid(),
    TG_ARGV[0],  -- 'user_roles.update' 等
    TG_TABLE_NAME,
    COALESCE(NEW.id, OLD.id),
    to_jsonb(OLD),
    to_jsonb(NEW)
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

## 影響
- `audit_logs` テーブルは INSERT ONLY（UPDATE/DELETE を RLS + トリガで禁止）
- 保持期間: 最低1年（NFR-05c）
- 参照: IT Admin / Tenant Admin のみ

## Related
- [監査ログ方針](../../spec/audit-logging/)
- [DB設計](../../detail/db/)（DD-DB-009 audit_logs）
- [NFR-05](../../requirements/nfr/)
