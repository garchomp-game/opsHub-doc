---
title: ADR-0003 マルチテナント分離戦略
description: テナントデータの分離方式を決定する
---

## ステータス
- **Accepted**（2026-02-22）

## コンテキスト
OpsHub はマルチテナントSaaSであり、テナント間のデータ分離が必要。
分離方式は DB 設計・RLS・バックアップ・パフォーマンスのすべてに影響するため、早期に決定する。

## 選択肢

### 案A: tenant_id カラム + RLS（採用）
- 全テーブルに `tenant_id` カラムを付与
- RLSポリシーで `tenant_id` をフィルタ
- 単一DB・単一スキーマ

### 案B: Schema 分離
- テナントごとに PostgreSQL スキーマを分離
- 強い分離だが、マイグレーション・管理コストが高い
- テナント数の増加に伴いスキーマ数が爆発

### 案C: DB 分離
- テナントごとに DB インスタンスを分離
- 最強の分離だが、コスト・運用が非現実的

## 決定
- **採用**: 案A（tenant_id + RLS）
- **採用理由**:
  - Supabase の標準的な推奨パターン
  - 単一DB でシンプルな運用
  - RLS で十分な分離が可能（ADR-0001 と統合）
  - マイグレーションが単一で済む
  - テナント横断の管理画面（IT Admin）も実装しやすい

## 影響
- **正の影響**:
  - 運用がシンプル（単一DB、単一マイグレーション）
  - テナント追加が INSERT 1行で完了
  - Index 設計で tenant_id をリーディングカラムにすれば性能も確保可能
- **負の影響**:
  - 全テーブルへの `tenant_id NOT NULL` 強制が必要（設計規約）
  - RLSポリシー漏れ＝テナント間データ漏洩の直接リスク
  - 大規模テナントとのリソース共有（将来的にはパーティション検討）
- **移行/ロールバック**:
  - 案Bへの移行は大規模なデータ移行が必要。初期に正しく設計することが重要

## 設計規約
1. **全業務テーブルに `tenant_id uuid NOT NULL REFERENCES tenants(id)` を付与**
2. **Indexは `(tenant_id, ...)` を先頭にする**
3. **RLSポリシーは必ず `tenant_id` フィルタを含む**
4. **例外**: `tenants` テーブル自体、`auth.users` 等のシステムテーブル

## Related
- ADR-0001（RBAC/RLS） / DD-DB-001 / requirements/roles
