---
title: ADR-0004 ユーザー表示名のための profiles テーブル導入
description: auth.users の RLS 制約を回避し、全 UI でユーザー表示名を参照可能にする設計決定
---

## ステータス
- **Accepted**（2026-02-24）

## コンテキスト

OpsHub の複数画面で、ユーザー名が **UUID のまま表示**される問題がレビューで報告されている。

### 根本原因

Supabase の `auth.users` テーブルは **auth スキーマ**に属しており、public スキーマの RLS ポリシーから直接参照できない。そのため、業務画面では `user_id`（UUID）をそのまま表示するか、`slice(0, 8)` で省略表示するワークアラウンドが散在している。

### 影響範囲

コードベース調査の結果、**16 箇所**で UUID 表示問題が確認された：

| 区分 | 箇所数 | 例 |
|---|---:|---|
| UI コンポーネント（直接表示） | 14 | KanbanBoard, ProjectDetail, WorkflowDetail, ReportClient, AuditLogViewer 等 |
| バックエンド / API | 2 | CSV エクスポート、レポート集計 |

> [!IMPORTANT]
> 全箇所の詳細は [profiles テーブル設計調査](file:///home/garchomp-game/workspace/starlight-test/opsHub-doc/src/content/docs/detail/research/profiles-table.md) §4「影響箇所一覧」を参照。

## 選択肢

### 案A: `public.profiles` テーブル + auth トリガー同期（採用）
- `auth.users` と 1:1 の `public.profiles` テーブルを作成
- `AFTER INSERT` / `AFTER UPDATE` トリガーで `auth.users` のメタデータを自動同期
- 業務画面では `profiles` を JOIN して `display_name` を取得
- Supabase 公式推奨パターンに準拠

### 案B: `auth.users` の直接参照
- `auth.admin.listUsers()` や `auth.getUser()` で直接取得
- **却下理由**:
  - RLS ポリシー内で auth スキーマを参照できない
  - サーバーサイドでしか使えず、Supabase クエリの JOIN に組み込めない
  - 管理画面用途（`service_role`）に限定される

### 案C: アプリ側キャッシュ（メモリ / Redis）
- ユーザー情報を Server Action でキャッシュし、クライアントに配布
- **却下理由**:
  - キャッシュの整合性管理が複雑（無効化タイミング、TTL 設計）
  - RLS の JOIN パターンに統合できない
  - 追加インフラ（Redis 等）が必要になる可能性

## 決定

- **採用**: 案A（`public.profiles` テーブル + auth トリガー同期）
- **採用理由**:
  - Supabase 公式推奨パターンであり、実績のある設計
  - RLS ポリシーと自然に統合可能（public スキーマのテーブル）
  - Supabase クエリの `select("*, profiles(display_name)")` で簡潔に JOIN 可能
  - トリガーによる自動同期でアプリ層の実装負担が最小限
  - 将来的に `avatar_url` 等のプロフィール情報も拡張可能

### 実装構成

```sql
-- profiles テーブル（auth.users と 1:1）
CREATE TABLE public.profiles (
    id           uuid         NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    display_name text         NOT NULL DEFAULT '',
    avatar_url   text,
    created_at   timestamptz  NOT NULL DEFAULT now(),
    updated_at   timestamptz  NOT NULL DEFAULT now(),
    CONSTRAINT profiles_pkey PRIMARY KEY (id)
);

-- INSERT トリガー: auth.users 登録時に profiles を自動作成
CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- UPDATE トリガー: メタデータ変更時に display_name を同期
CREATE TRIGGER on_auth_user_updated
    AFTER UPDATE ON auth.users
    FOR EACH ROW EXECUTE FUNCTION public.handle_user_update();
```

### JOIN パターン（統一規約）

```typescript
// 全箇所で統一する JOIN パターン
const { data } = await supabase
    .from("project_members")
    .select("user_id, profiles!inner(display_name)")
    .eq("project_id", projectId);
```

## 影響

- **正の影響**:
  - 全 16 箇所の UUID 表示問題が解消され、`display_name` で統一表示
  - Supabase の FK 自動検出により、JOIN の記述が簡潔
  - RLS で同テナントメンバーの profiles のみ閲覧可能（セキュリティ維持）
  - `ON DELETE CASCADE` により auth.users 削除時に自動クリーンアップ
  - 将来のプロフィール拡張（アバター、Bio 等）の基盤
- **負の影響**:
  - テーブル追加による DB スキーマの複雑化（軽微）
  - auth トリガー関数は `SECURITY DEFINER` のため、慎重な権限管理が必要
  - 既存ユーザーのバックフィルが必要（マイグレーション時に 1 回実行）
- **移行/ロールバック**:
  - マイグレーションで profiles テーブル作成 → バックフィル → アプリ修正の順で段階適用
  - ロールバック時は profiles テーブルと関連トリガーを DROP し、UUID 表示に戻す

## Related
- [profiles テーブル設計調査](file:///home/garchomp-game/workspace/starlight-test/opsHub-doc/src/content/docs/detail/research/profiles-table.md) / ADR-0001（RBAC/RLS 方式） / DD-DB-012（profiles DDL）
