---
title: ADR-0006 検索方式の選定
description: 全文検索の実装方式を決定する（pg_trgm + GIN インデックス）
---

## ステータス
- **Accepted**（2026-02-25）

## コンテキスト
OpsHub は申請（workflows）・プロジェクト（projects）・タスク（tasks）・経費（expenses）を横断的に検索する必要がある（REQ-G02）。
以下の制約・要件が存在する：

1. **日本語対応が必須** — ユーザー入力・データともに日本語が主体
2. **性能要件** — テナントあたり 10万レコード/テーブルのスケールで 1秒以内のレスポンス（NFR-02e）
3. **運用の簡潔さ** — 外部サービスへの依存を最小化し、Supabase（PostgreSQL）内で完結させたい
4. **段階的な拡張** — 初期リリースは簡易検索、将来的に高度な検索への移行も視野に入れる

## 選択肢

### 案A: pg_trgm 拡張 + GIN インデックス（採用）
- PostgreSQL 組み込みの `pg_trgm` 拡張を有効化
- `GIN` インデックスを検索対象カラムに作成
- `ILIKE` による partial match（部分一致）を基本とする
- 将来的に `tsvector` + 日本語辞書（`pg_bigm` 等）への移行も可能

### 案B: Supabase Vector（embeddings）
- OpenAI 等の埋め込みモデルでベクトル検索
- セマンティック検索が可能
- 外部 API 依存、コスト高、レイテンシ大

### 案C: Elasticsearch
- 高度な全文検索エンジン
- 日本語形態素解析（kuromoji）に対応
- 外部サービスの運用・管理が必要

### 案D: Meilisearch
- 軽量な検索エンジン
- 日本語対応は限定的
- 外部サービスの運用・管理が必要

## 決定
- **採用**: 案A（pg_trgm + GIN インデックス）
- **採用理由**:
  - PostgreSQL 内で完結し、外部依存なし
  - Supabase でネイティブサポートされている拡張
  - `ILIKE` + `pg_trgm` で日本語の部分一致検索が可能
  - GIN インデックスにより、10万レコード規模でも 1秒以内のレスポンスを実現可能
  - 実装コストが最も低い（SQL クエリのみで実現）
  - RLS ポリシーがそのまま適用される（セキュリティ維持）

## 検索対象

| テーブル | 検索カラム | インデックス |
|---|---|---|
| `workflows` | `title`, `description` | `GIN (title gin_trgm_ops, description gin_trgm_ops)` |
| `projects` | `name`, `description` | `GIN (name gin_trgm_ops, description gin_trgm_ops)` |
| `tasks` | `title` | `GIN (title gin_trgm_ops)` |
| `expenses` | `description` | `GIN (description gin_trgm_ops)` |

## 検索クエリ例

```sql
-- pg_trgm 拡張の有効化
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- GIN インデックスの作成例
CREATE INDEX idx_workflows_search
  ON workflows USING GIN (title gin_trgm_ops, description gin_trgm_ops);

-- 検索クエリ例
SELECT id, title, description
FROM workflows
WHERE tenant_id = $1
  AND (title ILIKE '%' || $2 || '%' OR description ILIKE '%' || $2 || '%')
ORDER BY created_at DESC
LIMIT 10;
```

## 影響
- **正の影響**:
  - 外部サービス不要で運用がシンプル
  - RLS がそのまま機能し、テナント分離が保証される
  - 既存の Supabase Client SDK で実装可能
  - マイグレーションで GIN インデックスを追加するだけで導入可能
- **負の影響**:
  - 形態素解析なし（「経費申請」で「経費」がヒットするが、「けいひ」ではヒットしない）
  - `ILIKE` は大量データでの複雑なクエリでは性能劣化の可能性あり
  - ランキング（関連度順ソート）は非対応（日付順でソート）
- **将来的な移行パス**:
  - `tsvector` + `pg_bigm`（日本語 bigram 辞書）への移行で形態素解析対応
  - 検索規模がさらに拡大した場合は Elasticsearch の導入を再検討

## Related
- REQ-G02（全文検索） / NFR-02e（検索1秒以内） / SPEC-SCR-G02 / SPEC-API-G01
