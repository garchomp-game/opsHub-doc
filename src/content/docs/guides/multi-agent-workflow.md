---
title: マルチエージェント開発ナレッジ
description: 複数AIエージェントを活用した開発のベストプラクティス
---

> このドキュメントは OpsHub 開発で得られた知見をまとめたものですが、他プロジェクトでも適用可能です。

## 1. ロール設計

### PM エージェント（常駐・1名）

会話セッションを維持し、全体を俯瞰する司令塔。

| 責務 | 具体的なアクション |
|---|---|
| タスク分解 | ユーザーの要求を並列実行可能な単位に分割 |
| プロンプト設計 | 各エージェント向けの詳細な作業指示を作成 |
| 成果物管理 | ウォークスルーの確認、ファイル移動、ナレッジ更新 |
| 品質ゲート | レビュー結果の集約、ネクストアクションの優先度判断 |
| ナレッジ蓄積 | `knowledge.md` の維持更新 |

### 作業エージェント（並列・N名）

PM が作成したプロンプトに従い、独立したタスクを実行。

| 責務 | 具体的なアクション |
|---|---|
| 実装 / 調査 / レビュー | プロンプトの指示どおりに作業 |
| ウォークスルー出力 | 成果物を指定フォルダに保存 |
| ビルド検証 | 作業後に `npm run build` で確認 |

---

## 2. プロンプト設計パターン

### ファイル構成ルール

```
prompts/
├── {カテゴリ}/
│   ├── {タスク名}.md      ← 1プロンプト = 1ファイル
│   └── ...
└── {カテゴリ}-overview.md  ← 全体まとめ（オプション）
```

**理由**: nvimtree 等のファイラーで素早く選択→クリップボードコピー→貼り付けが可能。

### プロンプトの構成要素

```markdown
## 作成/修正するファイル
- 明示的なフルパス（曖昧さゼロ）

## 参照する既存ファイル（正とするドキュメント）
- 設計ドキュメントのパス
- テンプレートのパス → フォーマット統一に必須
- ナレッジ（knowledge.md） → 共通パターンの把握

## 確認項目（チェックリスト形式）
- 番号付きで具体的に列挙
- 【重要】マークで優先度を明示

## 実行すべき検証
- ビルドコマンド（`npm run build` 等）

## 出力先・形式
- 成果物の保存パス
- frontmatter の指定
- レポート形式（✅/⚠️/❌）
```

### やってはいけないこと

| ❌ アンチパターン | ✅ 改善策 |
|---|---|
| 「いい感じにやって」 | 具体的なチェックリストを提示 |
| 参照先を省略 | フルパスで全ファイルを列挙 |
| 出力形式を指定しない | frontmatter + レポート形式を明示 |
| 1プロンプトに複数の独立タスク | 1プロンプト = 1タスクに分割 |
| テンプレート未指定 | 既存ドキュメントをフォーマット参照先として指定 |

---

## 3. 並列実行の判断基準

### 並列実行OK

- **異なるファイルを編集**するタスク同士
- **読み取り専用**の調査タスク同士
- **異なるディレクトリ**で完結するタスク同士

### 直列実行が必要

- **同じファイルを編集**するタスク同士
- 先行タスクの**出力を参照**する後続タスク
- **型定義の変更**を伴うタスク → 後続タスクの型チェックに影響

### 依存関係の判断フロー

```
Q1: 同じファイルを編集するか？
├─ Yes → 直列
└─ No
    Q2: 先行タスクの出力を参照するか？
    ├─ Yes → 直列
    └─ No → 並列OK
```

---

## 4. 成果物管理

### ウォークスルーの運用

| ルール | 詳細 |
|---|---|
| 保存先 | `logs/walkthroughs/{タスク名}.md` |
| 命名規則 | `{カテゴリ}-{番号}-{内容}.md` |
| frontmatter | `title` 必須（Astro ビルドに必要） |
| 内容 | 変更ファイル、設計判断、検証結果 |

### ナレッジの運用

| ルール | 詳細 |
|---|---|
| 保存先 | `logs/knowledge.md`（1ファイルに集約） |
| 更新タイミング | 各ラウンドの作業完了後 |
| 内容 | 共通パターン、チケット進捗、DB構成、技術スタック |
| 用途 | 新規エージェントへの参照資料として指定 |

### レビュー結果の運用

| ルール | 詳細 |
|---|---|
| 保存先 | `logs/reviews/{review名}.md` |
| PM の作業 | 結果集約 → 優先度分類（🔴即時/🟡次フェーズ） → 修正チケット化 |

---

## 5. ラウンド制ワークフロー

大規模開発は「ラウンド」単位で反復する。

```
Round N:
  1. PM: タスク分解 + プロンプト作成
  2. User: エージェントに投入（並列）
  3. PM: ウォークスルー確認 + ナレッジ更新
  4. PM: レビュープロンプト作成
  5. User: レビューエージェントに投入（並列）
  6. PM: レビュー結果集約 + 修正チケット → Round N+1 へ
```

### OpsHub での実績

| ラウンド | 内容 | 並列数 | 所要時間 |
|---|---|---|---|
| R1 | TICKET-02〜08, 11, 12 実装 | 5並列 | ~15分 |
| R2 | レビュー 1〜4 | 4並列 | ~5分 |
| R3 | FIX-01〜07 + RESEARCH-01 | 3並列 | ~10分 |
| R4 | TICKET-09, 10 実装 | 2並列 | ~5分 |
| R5 | レビュー 5〜6 + TICKET-01 | 3並列 | ~5分 |
| R6 | DOC-02〜10 ドキュメント整理 | 9並列 | ~15分 |
| R7 | 品質監査 1〜5 | 5並列 | 進行中 |

---

## 6. その他の知見

### Supabase CLI vs Docker Compose

- `npx supabase start` は裏で Docker コンテナを自動管理する
- `docker compose ls` には表示されないが `docker ps` では見える
- 手動 `docker-compose.yml` は不要（CLI が代替）
- マイグレーション管理は CLI ネイティブ（`supabase db reset`、`supabase db diff`）

### Astro Starlight の frontmatter

- YAML の `title` にコロン（`:`）を含む場合は**ダブルクォートで囲む**
- 全 `.md` ファイルに frontmatter が必須（なければビルドエラー）
- `autogenerate` を使えばサイドバーにディレクトリ内のファイルが自動追加される

### Next.js App Router のパターン

- Server Component ではデータ取得を `Promise.all()` で並列化
- `"use client"` は必要最小限の葉コンポーネントにのみ
- Server Action は `withAuth()` ラッパーパターンで認証・エラーハンドリングを統一
- `useTransition` でサーバーアクション呼び出し中の UI 状態管理
