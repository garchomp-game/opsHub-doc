---
title: 例外・エラー方針
description: エラーハンドリングの統一方針とユーザー向け表示ルール
---

## 目的 / In-Out / Related
- **目的**: エラー処理の一貫性を確保し、ユーザー体験とデバッグ容易性を両立する
- **対象範囲（In）**: エラー分類、表示方針、ログ方針
- **対象範囲（Out）**: 個別画面/APIのエラー詳細（→ 各SPEC-SCR/SPEC-API）
- **Related**: [NFR-01](../../requirements/nfr/) / [監査ログ方針](../audit-logging/)

---

## エラー分類

| カテゴリ | HTTPコード | 原因 | ユーザー表示 | ログレベル |
|---|---|---|---|---|
| バリデーション | 400 | 入力値不正 | フィールドごとのエラーメッセージ | info |
| 認証エラー | 401 | 未ログイン/トークン期限切れ | ログイン画面へリダイレクト | warn |
| 認可エラー | 403 | ロール不足 | 「権限がありません」 | warn |
| 未検出 | 404 | リソースが存在しない | 「見つかりません」 | info |
| 競合 | 409 | 楽観的ロック失敗 | 「他のユーザーが更新しました。再読込してください」 | info |
| レート制限 | 429 | リクエスト過多 | 「しばらくお待ちください」 | warn |
| サーバーエラー | 500 | 予期しないエラー | 「エラーが発生しました。管理者にお問い合わせください」 | error |

## エラーレスポンス形式

### Server Actions
```typescript
// 統一エラー型
type ActionResult<T> = 
  | { success: true; data: T }
  | { success: false; error: { code: string; message: string; fields?: Record<string, string> } };
```

### 画面表示方針
- **バリデーション**: フォームフィールド直下に赤テキストで表示（Ant Design Form.Item の rules）
- **操作エラー**: Ant Design の `message.error()` でトースト通知
- **致命的エラー**: `error.tsx` でフォールバックUI表示
- **認証/認可**: リダイレクト（ユーザーにエラー画面は見せない）

## エラーコード体系

```
ERR-{カテゴリ}-{番号}
```
| プレフィックス | カテゴリ |
|---|---|
| `ERR-AUTH` | 認証/認可 |
| `ERR-VAL` | バリデーション |
| `ERR-WF` | ワークフロー |
| `ERR-PJ` | プロジェクト/タスク |
| `ERR-EXP` | 経費 |
| `ERR-INV` | 請求 |
| `ERR-SYS` | システム（予期しないエラー） |

---

## 未決事項
- エラー通知（Slack等への自動通知）の要否
- エラーレポートの集約ツール（Sentry等）の選定
