---
title: SPEC-SCR-002 ダッシュボード
description: ダッシュボード画面の仕様
---

## 目的 / In-Out / Related
- **目的**: ログイン後のホーム画面。ロール別にKPIを表示し、未読通知・クイックアクションで日常業務への導線を提供する
- **対象範囲（In/Out）**: KPIカード表示、未読通知一覧、プロジェクト進捗、クイックアクション。通知詳細・一括既読は SCR-E01
- **Related**: REQ-G03 / [権限/認可](../../spec/authz/) / SPEC-SCR-E01

---

## 画面情報
- **画面ID**: SPEC-SCR-002
- **画面名**: ダッシュボード
- **対象ロール**: 全ロール（表示内容がロールにより異なる）
- **URL**: `/`（認証済みルート）
- **状態**: Approved
- **実装方式**: React Server Component（`page.tsx`）

---

## 主要ユースケース
- **全ロール**: 自分の申請状況を確認し、新規申請・工数入力などへ素早く遷移する
- **Approver / Tenant Admin**: 未処理の承認申請数を確認し、承認ワークフローへ遷移する
- **Member / PM**: 担当タスク数・今週の工数を確認する
- **PM**: 担当プロジェクトの進捗率を俯瞰する

---

## ワイヤーフレーム

```
┌──────────────────────────────────────────────────────────────────┐
│  ダッシュボード                                                  │
│                                                                  │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │
│  │📄 自分の │ │✔ 未処理の│ │📋 担当   │ │⏱ 今週の │           │
│  │  申請    │ │  申請    │ │  タスク  │ │  工数    │           │
│  │  3 件    │ │  5 件    │ │  8 件    │ │  24.5 h  │           │
│  │ (全ロール) │ │(Approver)│ │(Mem/PM)  │ │(Mem/PM)  │           │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘           │
│                                                                  │
│  ┌─ プロジェクト進捗 (PMのみ) ────────── 一覧 → ──┐            │
│  │ PJ-Alpha  ████████░░░ 75%                       │            │
│  │ PJ-Beta   ████░░░░░░░ 40%                       │            │
│  └──────────────────────────────────────────────────┘            │
│                                                                  │
│  ┌─ 🔔 未読通知 ──── すべて見る ─┐ ┌─ クイックアクション ──┐  │
│  │ ・経費申請が承認されました     │ │ [＋ 新規申請]         │  │
│  │ ・タスクにアサインされました   │ │ [⏱ 工数を入力]       │  │
│  │ ・PJ-A にメンバー追加         │ │ [📋 プロジェクト一覧] │  │
│  │ （最新5件 / 0件時は空状態）   │ │                       │  │
│  └───────────────────────────────┘ └───────────────────────┘  │
└──────────────────────────────────────────────────────────────────┘
```

---

## UI構成（概要）

### KPIカード（上部 最大4枚・ロール別）

| # | カード名 | アイコン | データソース | クエリ条件 | 表示ロール | 備考 |
|---|---|---|---|---|---|---|
| 1 | 自分の申請 | `FileTextOutlined` | `workflows` | `created_by = me` AND `status IN ('draft','submitted')` | 全ロール | 未完了件数のみカウント |
| 2 | 未処理の申請 | `CheckCircleOutlined` | `workflows` | `status = 'submitted'` AND `approver_id = me` | Approver / Tenant Admin | 件数 > 0 で赤文字 (`#cf1322`) |
| 3 | 担当タスク | `ProjectOutlined` | `tasks` | `assignee_id = me` AND `status != 'done'` | Member / PM | 未完了タスクのみ |
| 4 | 今週の工数 | `ClockCircleOutlined` | `timesheets` | `user_id = me` AND `work_date` が今週（月〜日） | Member / PM | 小数第1位表示、単位 `h` |

- すべて `Ant Design Statistic` + `Card hoverable` で表示
- レスポンシブ: `xs=24 sm=12 lg=6`

### プロジェクト進捗セクション（PM のみ）

| 項目 | 詳細 |
|---|---|
| 表示条件 | ログインユーザーが PM ロール、かつ担当プロジェクトが 1 件以上 |
| データソース | `projects` テーブル（`pm_id = me`, `status IN ('planning','active')`） |
| 進捗率算出 | プロジェクトごとに `tasks` の完了率: `done / total * 100`（タスク 0 件 → 0%） |
| UI | `Ant Design Progress` バー + プロジェクト名。レスポンシブ `xs=24 sm=12 lg=8` |
| ヘッダー右 | 「一覧 →」リンク → `/projects` |

### 通知セクション

| 項目 | 詳細 |
|---|---|
| 表示対象 | 全ロール |
| データソース | `notifications` テーブル |
| クエリ条件 | `user_id = me` AND `is_read = false`、`created_at DESC`、`LIMIT 5` |
| 表示内容 | タイトル（リンク付き）、本文、作成日時（`ja-JP` ロケール） |
| リンク生成 | `resource_type` → URL マッピング: `workflow`→`/workflows/{id}`, `task`→`/tasks/{id}`, `project`→`/projects/{id}`, `expense`→`/expenses/{id}` |
| 空状態 | `Ant Design Empty`（PRESENTED_IMAGE_SIMPLE）:「未読の通知はありません」|
| ヘッダー右 | 「すべて見る」→ `/notifications` |
| レイアウト | `Col xs=24 lg=14` |

### クイックアクション

| ボタン | アイコン | 遷移先 | スタイル |
|---|---|---|---|
| 新規申請 | `PlusOutlined` | `/workflows/new` | `type="primary"` `block` `size="large"` |
| 工数を入力 | `ClockCircleOutlined` | `/timesheets` | `block` `size="large"` |
| プロジェクト一覧 | `ProjectOutlined` | `/projects` | `block` `size="large"` |

- レイアウト: `Col xs=24 lg=10`
- ロール制限なし（全ロール共通）

---

## 権限別表示ルール

| ロール | 表示されるKPIカード | プロジェクト進捗 | 備考 |
|---|---|---|---|
| Member | 自分の申請 / 担当タスク / 今週の工数 | ✗ | タスク・工数中心 |
| PM | 自分の申請 / 担当タスク / 今週の工数 | ✔ | プロジェクト管理向け |
| Approver | 自分の申請 / **未処理の申請** | ✗ | 承認業務中心 |
| Tenant Admin | 自分の申請 / **未処理の申請** | ✗ | Approver と同じ権限 |

> **判定ロジック**（`page.tsx`）:
> - `isApprover` = `hasRole(user, tenantId, ["approver", "tenant_admin"])`
> - `isMemberOrPm` = `hasRole(user, tenantId, ["member", "pm"])`
> - `isPm` = `hasRole(user, tenantId, ["pm"])`

通知セクション・クイックアクションは全ロール共通で表示される。

---

## 振る舞い・遷移
- **正常系**: ページロード時にすべてのKPI・通知データを取得し表示
- **通知クリック**: `resource_type` / `resource_id` に基づきリソース画面へ遷移
- **クイックアクション**: 各ボタンクリックで対象画面へ遷移
- **プロジェクト進捗「一覧→」**: `/projects` へ遷移
- **異常系**: 各データ取得関数はエラー時にデフォルト値（`0` / `[]`）を返し、画面は正常表示を維持（`console.error` でログ出力）

---

## エラー/例外
- 各KPIデータ取得失敗: デフォルト値 `0` を表示（ユーザーにエラー非表示）
- 通知取得失敗: 空配列を返し「未読の通知はありません」を表示
- プロジェクト進捗取得失敗: セクション非表示

---

## データ取得パターン

### Server Component 設計

本画面は **React Server Component** として実装されている。

| 設計判断 | 理由 |
|---|---|
| Server Component 採用 | クライアント JS バンドル削減。認証・RLS を Server 側で完結 |
| `requireAuth()` | ページレンダリング前に認証チェック。未認証時はリダイレクト |
| `hasRole()` | Server Component 用のロール判定ヘルパー（Server Action の `requireRole()` と対） |

### 並行データ取得（`Promise.all`）

6 つのデータ取得を `Promise.all` で並行実行し、ウォーターフォールを回避する。

```typescript
const [
    pendingApprovals,   // 承認待ち件数
    myWorkflows,        // 自分の申請数
    myTasks,            // 担当タスク数
    weeklyHours,        // 今週の工数
    projectProgress,    // PJ進捗
    unreadNotifications // 未読通知
] = await Promise.all([
    isApprover ? getPendingApprovalsCount() : Promise.resolve(0),
    getMyWorkflowsCount(),
    isMemberOrPm ? getMyTasksCount() : Promise.resolve(0),
    isMemberOrPm ? getWeeklyHours() : Promise.resolve(0),
    isPm ? getProjectProgress() : Promise.resolve([]),
    getUnreadNotifications(),
]);
```

- ロールに該当しないデータは `Promise.resolve()` で即時解決し、不要なDB問い合わせをスキップ
- 各関数は個別に `requireAuth()` を呼び出し、RLS によりテナント内データのみ取得

### データ取得関数一覧

| 関数名 | ファイル | 戻り値 | テーブル | 概要 |
|---|---|---|---|---|
| `getPendingApprovalsCount` | `_actions/dashboard.ts` | `number` | `workflows` | 自分宛の承認待ち件数 |
| `getMyWorkflowsCount` | `_actions/dashboard.ts` | `number` | `workflows` | 自分が作成した未完了申請数 |
| `getMyTasksCount` | `_actions/dashboard.ts` | `number` | `tasks` | 自分に割当の未完了タスク数 |
| `getWeeklyHours` | `_actions/dashboard.ts` | `number` | `timesheets` | 今週（月〜日）の合計工数 |
| `getProjectProgress` | `_actions/dashboard.ts` | `ProjectProgress[]` | `projects` + `tasks` | PM 担当PJの進捗率 |
| `getUnreadNotifications` | `_actions/dashboard.ts` | `NotificationRow[]` | `notifications` | 未読通知 最新5件 |

---

## 監査ログポイント
- ダッシュボード閲覧自体はログ対象外（読み取り専用画面）

---

## 関連リンク
- Related: REQ-G03 / SPEC-SCR-E01 / SPEC-SCR-B01 / SPEC-SCR-B02 / SPEC-SCR-C01-1
