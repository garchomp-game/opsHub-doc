---
title: SPEC-SCR-D01 経費管理
description: 経費一覧・経費申請（新規作成）画面の仕様
---

## 目的 / In-Out / Related
- **目的**: 経費の一覧表示・フィルタリング、および経費申請の新規作成を提供する
- **対象範囲（In/Out）**: 一覧表示、カテゴリフィルタ、申請フォーム入力・バリデーション・送信。添付ファイル機能は対象外
- **Related**: REQ-D01 / SPEC-API-D01 / DD-DB-expenses / DD-DB-workflows

---

## 画面① 経費一覧

### 画面情報
- **画面ID**: SPEC-SCR-D01-LIST
- **画面名**: 経費管理
- **対象ロール**: 全認証ユーザー（表示範囲はロールにより異なる）
- **URL**: `/expenses`
- **状態**: Approved

### ロール別表示ルール

| ロール | 表示範囲 |
|---|---|
| Member / PM / Approver | **自分が作成した経費のみ** (`created_by = 自身`) |
| Accounting / TenantAdmin | **テナント内の全経費** |

### 主要ユースケース
- ユーザーが自分の経費申請一覧を確認する
- 経理/管理者がテナント全体の経費を確認する
- カテゴリでフィルタして特定種別の経費を絞り込む

### UI構成（概要）

```
┌─────────────────────────────────────────────────────────┐
│  [h2] 経費管理                        [+ 経費申請] ボタン │
├─────────────────────────────────────────────────────────┤
│  フィルタ Card                                           │
│  ┌────────────────────────────────────────────┐         │
│  │ [カテゴリ ▼ すべてのカテゴリ] [フィルタ]     │         │
│  └────────────────────────────────────────────┘         │
├─────────────────────────────────────────────────────────┤
│  一覧テーブル Card                                       │
│  ┌──────┬──────┬───────┬──────┬────────┬──────┬────┬────┬────┐
│  │申請番号│ｶﾃｺﾞﾘ│ 金額  │ 日付 │ﾌﾟﾛｼﾞｪｸﾄ│ｽﾃｰﾀｽ│説明│申請日│申請者│
│  ├──────┼──────┼───────┼──────┼────────┼──────┼────┼────┼────┤
│  │WF-001│交通費│¥3,200│01/15│PJ-A    │申請中│…  │01/15│山田│
│  │WF-002│会議費│¥5,000│01/14│PJ-B    │承認済│…  │01/14│鈴木│
│  └──────┴──────┴───────┴──────┴────────┴──────┴────┴────┴────┘
│  全 XX 件                                     20件/ページ │
└─────────────────────────────────────────────────────────┘
```

### テーブル列定義

| # | 列名 | データソース | 表示形式 | 備考 |
|---|---|---|---|---|
| 1 | 申請番号 | `workflows.workflow_number` | リンク（`/workflows/{id}`） | ワークフロー詳細へ遷移 |
| 2 | カテゴリ | `expenses.category` | Tag（色分け） | 下記カテゴリ色参照 |
| 3 | 金額 | `expenses.amount` | `¥` + カンマ区切り | — |
| 4 | 日付 | `expenses.expense_date` | `ja-JP` ロケール日付 | — |
| 5 | プロジェクト | `projects.name` | リンク（`/projects/{id}`） | プロジェクト詳細へ遷移 |
| 6 | ステータス | `workflows.status` | Tag（色分け） | 下記ステータス色参照 |
| 7 | 説明 | `expenses.description` | 省略表示（ellipsis） | 未入力時は「—」 |
| 8 | 申請日 | `expenses.created_at` | `ja-JP` ロケール日付 | — |
| 9 | 申請者 | `profiles.display_name` | テキスト | 未設定時は「—」 |

### カテゴリ色定義

| カテゴリ | Tag色 |
|---|---|
| 交通費 | `blue` |
| 宿泊費 | `purple` |
| 会議費 | `cyan` |
| 消耗品費 | `orange` |
| 通信費 | `green` |
| その他 | `default` |

### ワークフローステータス色定義

| ステータス | 表示ラベル | Tag色 |
|---|---|---|
| `draft` | 下書き | `default` |
| `submitted` | 申請中 | `processing` |
| `approved` | 承認済 | `success` |
| `rejected` | 差戻し | `error` |
| `withdrawn` | 取下げ | `warning` |

### フィルタ

| フィルタ項目 | 型 | 選択肢 | 備考 |
|---|---|---|---|
| カテゴリ | select | すべてのカテゴリ / 交通費 / 宿泊費 / 会議費 / 消耗品費 / 通信費 / その他 | GET パラメータ `?category=` で送信 |

### ページネーション
- 1ページ当たり **20件**
- 合計件数を `全 XX 件` で表示

### 振る舞い・遷移
- 「経費申請」ボタン → `/expenses/new` へ遷移
- 申請番号リンク → `/workflows/{id}` へ遷移（ワークフロー詳細）
- プロジェクトリンク → `/projects/{id}` へ遷移
- フィルタ適用 → `GET /expenses?category=xxx` でページリロード

---

## 画面② 経費申請（新規作成）

### 画面情報
- **画面ID**: SPEC-SCR-D01-NEW
- **画面名**: 経費申請
- **対象ロール**: 全認証ユーザー
- **URL**: `/expenses/new`
- **状態**: Approved

### 主要ユースケース
- ユーザーが経費の詳細を入力し、下書き保存または送信する
- 送信時にワークフローが自動作成され、承認者に通知される

### UI構成（概要）

```
┌──────────────────────────────────────┐
│  [h2] 経費申請                        │
├──────────────────────────────────────┤
│  Card                                │
│  ┌────────────────────────────────┐  │
│  │ 日付       [DatePicker       ] │  │
│  │ カテゴリ   [Select ▼         ] │  │
│  │ 金額       [¥ InputNumber    ] │  │
│  │ プロジェクト[Select ▼         ] │  │
│  │ 説明       [TextArea         ] │  │
│  │ 承認者     [Select ▼         ] │  │
│  │ ────────────────────────────── │  │
│  │ [下書き保存] [送信] [キャンセル] │  │
│  └────────────────────────────────┘  │
└──────────────────────────────────────┘
```

### 入力項目

| 項目 | 型 | 必須 | バリデーション | 備考 |
|---|---|---:|---|---|
| 日付 | DatePicker | ✅ | 必須チェック | 経費発生日を選択 |
| カテゴリ | Select | ✅ | 定義済み6種別から選択 | 交通費/宿泊費/会議費/消耗品費/通信費/その他 |
| 金額 | InputNumber | ✅ | 1円以上、10,000,000円以下 | `¥` プレフィクス、カンマ区切り表示 |
| プロジェクト | Select | ✅ | テナント内プロジェクト（planning/active） | 動的に取得 |
| 説明 | TextArea | — | — | 3行表示、任意入力 |
| 承認者 | Select | ✅ | Approver/Accounting/TenantAdmin ロールのユーザー | `表示名（ロール）` 形式で表示 |

### 承認者セレクト表示形式
- `{display_name}（{ロールラベル}）` の形式で表示
- ロールラベル: `approver` → 承認者 / `accounting` → 経理 / `tenant_admin` → テナント管理者

### アクションボタン

| ボタン | 種別 | 動作 |
|---|---|---|
| 下書き保存 | default | `status: "draft"` でワークフロー+経費を作成 |
| 送信 | primary | `status: "submitted"` でワークフロー+経費を作成 |
| キャンセル | default | `/expenses` へ遷移（入力内容は破棄） |

### ワークフロー連動
経費申請の作成時に以下のワークフローが **自動的に作成** される:

1. `next_workflow_number` RPC で採番
2. `workflows` テーブルに INSERT（`type: "expense"`）
3. `expenses` テーブルに INSERT（`workflow_id` を紐付け）
4. 監査ログ書き込み
5. `/expenses` パスのキャッシュ無効化

ワークフロータイトルは `経費申請: {カテゴリ} ¥{金額}` の形式で自動生成される。

### 振る舞い・遷移
- 正常系（下書き）: 保存 → `/expenses` へ遷移、トースト「下書きを保存しました」
- 正常系（送信）: 送信 → `/expenses` へ遷移、トースト「経費申請を送信しました」
- 異常系: バリデーション失敗 → フィールドごとにエラーメッセージ表示
- Server Action エラー → エラーメッセージをトースト表示

---

## エラー/例外
- バリデーションエラー: 各フィールドの `rules` に基づきフォーム上にインライン表示
- サーバーエラー: `message.error()` でトースト通知
- ネットワークエラー: 入力内容は保持したままリトライ可能

## 監査ログポイント
- `expense.create`: 下書き保存時
- `expense.submit`: 送信時

## 関連リンク
- Related: REQ-D01 / SPEC-API-D01 / SPEC-SCR-B01（ワークフロー一覧） / SPEC-SCR-B03（ワークフロー詳細）
