---
title: SPEC-SCR-D03 経費集計
description: 経費データのカテゴリ別・プロジェクト別・月別集計/レポート画面の仕様
---

## 目的 / In-Out / Related
- **目的**: 経費データを多角的に集計・分析し、レポートとして可視化する
- **対象範囲（In/Out）**: カテゴリ別/PJ別/月別集計、サマリー統計、グラフ表示。CSV出力は対象外（Phase 2 以降）
- **Related**: REQ-D02 / SPEC-API-D02 / [SCR-D01 経費管理](./scr-d01/) / DD-DB-008 expenses

---

## 画面情報
- **画面ID**: SPEC-SCR-D03
- **画面名**: 経費集計
- **対象ロール**: Accounting, PM, Tenant Admin
- **URL**: `/expenses/summary`
- **状態**: Draft

---

## 主要ユースケース
- 経理担当が月次の経費レポートを確認する
- PM がプロジェクト別の経費消化状況を把握する
- テナント管理者が経費の全体傾向（カテゴリ構成・月次推移）を分析する

---

## ワイヤーフレーム

```
┌──────────────────────────────────────────────────────────────────────┐
│  経費集計                                                            │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────────┐│
│  │ フィルタ Card                                                    ││
│  │  期間: [From ▼] 〜 [To ▼]  カテゴリ: [全て ▼]                   ││
│  │  PJ:   [全プロジェクト ▼]  ステータス: [全て ▼]  [集計]         ││
│  └──────────────────────────────────────────────────────────────────┘│
│                                                                      │
│  ┌──────────┬──────────┬──────────┬──────────┐                      │
│  │ 合計金額 │   件数   │ 平均金額 │ 最高金額 │  ← サマリーカード    │
│  │¥1,240,000│   48件   │ ¥25,833  │ ¥120,000 │                      │
│  └──────────┴──────────┴──────────┴──────────┘                      │
│                                                                      │
│  ┌─────────┬──────────┬─────────┐                                   │
│  │カテゴリ別│PJ別     │月別推移  │  ← タブ切り替え                  │
│  └─────────┴──────────┴─────────┘                                   │
│                                                                      │
│  ┌──────────────────────┬────────────────────────────────────────┐  │
│  │ 円グラフ             │ カテゴリ別テーブル                      │  │
│  │      ╭───╮           │ ┌──────┬────┬──────────┬─────┐        │  │
│  │    ╭─┤   ├─╮         │ │ｶﾃｺﾞﾘ│件数│  合計金額 │割合 │        │  │
│  │   │  │   │  │        │ ├──────┼────┼──────────┼─────┤        │  │
│  │    ╰─┤   ├─╯         │ │交通費│ 15 │  ¥180,000│ 30% │        │  │
│  │      ╰───╯           │ │宿泊費│  8 │  ¥240,000│ 40% │        │  │
│  │                      │ │会議費│ 10 │   ¥80,000│ 13% │        │  │
│  │                      │ │…     │ …  │   …      │ …   │        │  │
│  │                      │ ├──────┼────┼──────────┼─────┤        │  │
│  │                      │ │合計  │ 48 │  ¥600,000│100% │        │  │
│  └──────────────────────┴─┴──────┴────┴──────────┴─────┘────────┘  │
└──────────────────────────────────────────────────────────────────────┘
```

---

## フィルタ

| フィルタ項目 | 型 | 選択肢 | デフォルト | 備考 |
|---|---|---|---|---|
| 期間（From） | DatePicker | — | 当月1日 | — |
| 期間（To） | DatePicker | — | 当月末日 | From 以降の日付のみ選択可 |
| カテゴリ | Select | 全て / 交通費 / 宿泊費 / 会議費 / 消耗品費 / 通信費 / その他 | 全て | — |
| プロジェクト | Select | 全プロジェクト / テナント内PJ一覧 | 全プロジェクト | — |
| ステータス | Select | 全て / 承認済のみ | 全て | 「承認済のみ」= `workflows.status = 'approved'` |

- フィルタ適用は「集計」ボタン押下で Server Component の再描画（`searchParams` 経由）

---

## サマリーカード

| カード | データソース | 表示形式 | 備考 |
|---|---|---|---|
| 合計金額 | `SUM(expenses.amount)` | `¥` + カンマ区切り | フィルタ条件に合致するもの |
| 件数 | `COUNT(expenses.id)` | `XX件` | — |
| 平均金額 | `AVG(expenses.amount)` | `¥` + カンマ区切り（小数点以下切り捨て） | — |
| 最高金額 | `MAX(expenses.amount)` | `¥` + カンマ区切り | — |

---

## 集計ビュー

### ビュー① カテゴリ別集計（デフォルト）

#### グラフ
- **種類**: 円グラフ（Pie Chart）
- **データ**: カテゴリ別の合計金額
- **凡例**: カテゴリ名 + 割合（%）

#### テーブル

| # | 列名 | データソース | 表示形式 | 備考 |
|---|---|---|---|---|
| 1 | カテゴリ | `expenses.category` | テキスト（Tag色付き） | SCR-D01 と同色定義 |
| 2 | 件数 | `COUNT(*)` | 数値 | — |
| 3 | 合計金額 | `SUM(amount)` | `¥` + カンマ区切り | — |
| 4 | 割合 | 合計金額 / 全体合計 × 100 | `XX%` | 小数点1桁 |

- フッター行に **合計** を表示

### ビュー② プロジェクト別集計

#### グラフ
- **種類**: 横棒グラフ（Bar Chart）
- **データ**: プロジェクト別の合計金額
- **軸**: X=金額、Y=プロジェクト名

#### テーブル

| # | 列名 | データソース | 表示形式 | 備考 |
|---|---|---|---|---|
| 1 | プロジェクト | `projects.name` | テキスト | — |
| 2 | 件数 | `COUNT(*)` | 数値 | — |
| 3 | 合計金額 | `SUM(amount)` | `¥` + カンマ区切り | — |

- フッター行に **合計** を表示

### ビュー③ 月別推移

#### グラフ
- **種類**: 折れ線グラフ（Line Chart）
- **データ**: 月ごとの合計金額
- **軸**: X=月（`YYYY/MM`）、Y=金額

#### テーブル

| # | 列名 | データソース | 表示形式 | 備考 |
|---|---|---|---|---|
| 1 | 月 | `expense_date` を月単位に切り捨て | `YYYY年MM月` | — |
| 2 | 件数 | `COUNT(*)` | 数値 | — |
| 3 | 合計金額 | `SUM(amount)` | `¥` + カンマ区切り | — |

- フッター行に **合計** を表示

---

## カテゴリ色定義

SCR-D01 と統一する。

| カテゴリ | Tag色 |
|---|---|
| 交通費 | `blue` |
| 宿泊費 | `purple` |
| 会議費 | `cyan` |
| 消耗品費 | `orange` |
| 通信費 | `green` |
| その他 | `default` |

---

## データ取得パターン

- **Server Component** で直接クエリ（工数集計 SCR-C03-2 / API-C03-2 と同パターン）
- フィルタ条件は `searchParams` 経由で受け取り、Server Component 内で Supabase クエリに変換
- 4つの集計クエリを `Promise.all` で並列実行

```
Page (Server Component)
  └─ searchParams からフィルタ条件を取得
  └─ Promise.all([
       getExpenseSummaryByCategory(tenantId, filters),
       getExpenseSummaryByProject(tenantId, filters),
       getExpenseSummaryByMonth(tenantId, filters),
       getExpenseStats(tenantId, filters),
     ])
  └─ SummaryCards (Server Component)
  └─ AggregationTabs (Client Component)
       ├─ CategoryView: PieChart + Table
       ├─ ProjectView: BarChart + Table
       └─ MonthlyView: LineChart + Table
```

---

## 権限

| ロール | アクセス | データ範囲 |
|---|---|---|
| Accounting | ✅ | テナント内全経費 |
| PM | ✅ | テナント内全経費 |
| Tenant Admin | ✅ | テナント内全経費 |
| Member / Approver | ❌ | アクセス不可（403リダイレクト） |

---

## 振る舞い・遷移
- 正常系: フィルタ条件を変更 → 「集計」ボタン押下 → サマリー・グラフ・テーブルが更新
- タブ切替: カテゴリ別 / PJ別 / 月別のタブクリックでビュー切替（Client-side、再クエリなし）
- データなし: 「該当する経費データがありません」を表示
- 権限エラー時: `/dashboard` にリダイレクト（`requireRole` で制御）

---

## エラー/例外
- 権限不足: `requireRole` で検証し、403時はダッシュボードへリダイレクト
- クエリエラー: エラーカード表示「データの取得に失敗しました。再度お試しください」
- 期間不正（From > To）: バリデーションエラー「開始日は終了日以前を指定してください」

---

## 監査ログポイント
- 集計画面は **参照のみ** のため、監査ログは記録しない
- 将来のCSVエクスポート実装時に `expense.export` アクションを追加予定

---

## 関連リンク
- Related: REQ-D02 / SPEC-API-D02 / [SCR-D01 経費管理](./scr-d01/) / [SCR-C03-2 工数集計](./scr-c03-2/) / DD-DB-008 expenses
