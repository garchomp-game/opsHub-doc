---
title: SPEC-SCR-G02 全文検索
description: ワークフロー・プロジェクト・タスク・経費を横断検索する画面の仕様
---

## 目的 / In-Out / Related
- **目的**: テナント内のワークフロー・プロジェクト・タスク・経費を横断的にキーワード検索し、結果を一覧表示する
- **対象範囲（In/Out）**: 検索結果の表示・カテゴリフィルタ・ページネーション。検索インデックス管理は ADR-0006 の範囲
- **Related**: REQ-G02 / SPEC-API-G01 / ADR-0006（検索方式） / NFR-02e（検索1秒以内）

---

## 画面情報
- **画面ID**: SPEC-SCR-G02
- **画面名**: 全文検索
- **対象ロール**: 全ロール（Member, Approver, PM, Accounting, IT Admin, Tenant Admin）
- **URL**: `/search?q={キーワード}`
- **状態**: Draft

---

## ロール別表示ルール

| ロール | ワークフロー | プロジェクト | タスク | 経費 |
|---|---|---|---|---|
| Member | 自分が作成した申請 | アサイン済PJのみ | 自分が担当 | **自分の分のみ** |
| Approver | 自分が作成 + 承認依頼 | アサイン済PJのみ | 自分が担当 | 自分の分のみ |
| PM | テナント内全件 | テナント内全件 | テナント内全件 | 自分の分のみ |
| Accounting | テナント内全件 | テナント内全件 | テナント内全件 | **テナント内全件** |
| Tenant Admin | テナント内全件 | テナント内全件 | テナント内全件 | **テナント内全件** |

> RLS ポリシーにより自動制御される。

---

## 主要ユースケース
- ヘッダーの検索バーにキーワードを入力し、Enter または検索アイコンをクリックして検索画面へ遷移する
- 検索結果をカテゴリ別タブで絞り込む
- 検索結果カードをクリックして対象画面（申請詳細・プロジェクト詳細等）へ遷移する
- 検索結果が0件の場合、空状態メッセージを確認する

---

## UI構成（概要）

```
┌────────────────────────────────────────────────────────────────┐
│  ヘッダー                              [🔍 検索バー]            │
├────────────────────────────────────────────────────────────────┤
│  [h2] 検索結果: "キーワード"                    XX 件ヒット      │
├────────────────────────────────────────────────────────────────┤
│  カテゴリタブ                                                   │
│  [ すべて | ワークフロー(12) | プロジェクト(3) | タスク(8) | 経費(5) ] │
├────────────────────────────────────────────────────────────────┤
│  検索結果 Card List                                             │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 📋 申請タイトル（**キーワード**ハイライト）     [承認済] Tag │  │
│  │ 説明文のスニペット... **キーワード** ...が含まれています     │  │
│  │ 作成日: 2026-02-20                        → 詳細を見る     │  │
│  └──────────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 📁 プロジェクト名（**キーワード**ハイライト）  [進行中] Tag │  │
│  │ プロジェクトの説明文スニペット...                           │  │
│  │ 作成日: 2026-02-15                        → 詳細を見る     │  │
│  └──────────────────────────────────────────────────────────┘  │
│  ...                                                           │
│                                              もっと見る →       │
├────────────────────────────────────────────────────────────────┤
│  空状態（結果なし時）                                            │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │       🔍                                                  │  │
│  │   「キーワード」に一致する結果が見つかりませんでした          │  │
│  │   別のキーワードで検索してみてください                       │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────┘
```

---

## カテゴリタブ定義

| タブ名 | フィルタ値 | 対象テーブル | 検索カラム |
|---|---|---|---|
| すべて | `all`（デフォルト） | 全テーブル | — |
| ワークフロー | `workflows` | `workflows` | `title`, `description` |
| プロジェクト | `projects` | `projects` | `name`, `description` |
| タスク | `tasks` | `tasks` | `title` |
| 経費 | `expenses` | `expenses` | `description` |

- 各タブにはヒット件数をバッジで表示
- URL パラメータ: `?q=キーワード&category=workflows`

---

## 検索結果カード定義

| # | 要素 | 内容 | 備考 |
|---|---|---|---|
| 1 | カテゴリアイコン | 📋 ワークフロー / 📁 プロジェクト / ✅ タスク / 💰 経費 | カテゴリ別に色分け |
| 2 | タイトル | 対象レコードのタイトル | キーワード部分を `<mark>` でハイライト |
| 3 | スニペット | 説明文から前後50文字を抽出 | キーワード部分をハイライト。説明なしは非表示 |
| 4 | ステータス Tag | 各リソースのステータス | 色定義は各画面仕様に準拠 |
| 5 | 日付 | `created_at` | `ja-JP` ロケール日付 |
| 6 | リンク | 対象画面へのリンク | 下記遷移先参照 |

### カテゴリ別遷移先

| カテゴリ | 遷移先URL |
|---|---|
| ワークフロー | `/workflows/{id}` |
| プロジェクト | `/projects/{id}` |
| タスク | `/projects/{project_id}/tasks` （※タスク詳細がない場合） |
| 経費 | `/expenses/{id}` |

---

## ステータス Tag 色定義

### ワークフロー

| ステータス | 表示ラベル | Tag色 |
|---|---|---|
| `draft` | 下書き | `blue` |
| `submitted` | 申請中 | `orange` |
| `approved` | 承認済 | `green` |
| `rejected` | 差戻し | `red` |
| `withdrawn` | 取下げ | `default` |

### プロジェクト

| ステータス | 表示ラベル | Tag色 |
|---|---|---|
| `planning` | 計画中 | `blue` |
| `active` | 進行中 | `green` |
| `completed` | 完了 | `default` |
| `archived` | アーカイブ | `default` |

### タスク

| ステータス | 表示ラベル | Tag色 |
|---|---|---|
| `todo` | 未着手 | `blue` |
| `in_progress` | 進行中 | `orange` |
| `done` | 完了 | `green` |

### 経費

| ステータス | 表示ラベル | Tag色 |
|---|---|---|
| `draft` | 下書き | `blue` |
| `submitted` | 申請中 | `orange` |
| `approved` | 承認済 | `green` |
| `rejected` | 差戻し | `red` |

---

## 検索バー（ヘッダー共通コンポーネント）

| 項目 | 仕様 |
|---|---|
| 配置 | グローバルヘッダー内 |
| 入力 | テキスト入力（プレースホルダー: 「検索…」） |
| アクション | Enter キーまたは 🔍 アイコンクリックで `/search?q={入力値}` へ遷移 |
| 最小文字数 | 1文字以上（空文字は検索しない） |
| 最大文字数 | 100文字 |

---

## ページネーション
- 「すべて」タブ: 各カテゴリ **10件ずつ** 表示。カテゴリ内に追加がある場合は「もっと見る →」リンクで該当カテゴリタブへ遷移
- カテゴリ別タブ: **20件/ページ**、オフセットベースページネーション
- ソート: `created_at` 降順（固定）

---

## 振る舞い・遷移
- ヘッダー検索バーで Enter → `/search?q={keyword}` へ遷移
- カテゴリタブクリック → URL パラメータ `category` を更新し再検索
- 結果カードクリック → 各リソースの詳細画面へ遷移
- 「もっと見る →」クリック → 該当カテゴリタブへ切り替え
- 検索クエリ変更 → 検索バーで再入力し Enter で再検索
- 権限エラー時 → ダッシュボードへリダイレクト（通常は RLS で制御されるため発生しない）

---

## エラー/例外
- 検索クエリが空 → 検索バーにフォーカスし、入力を促す
- サーバーエラー → `message.error()` でトースト通知「検索に失敗しました。再度お試しください」
- ネットワークエラー → 検索クエリを保持したままリトライ可能
- 検索結果が0件 → 空状態 UI を表示（上記 UI 構成参照）

---

## 監査ログポイント
- 検索操作自体は監査ログ不要
- 検索結果から遷移した先の操作は各画面仕様の監査ログに準拠

---

## 関連リンク
- Related: REQ-G02 / SPEC-API-G01 / ADR-0006（検索方式） / NFR-02e（検索1秒以内）
